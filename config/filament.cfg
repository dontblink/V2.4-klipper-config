[filament_switch_sensor top_sensor]
switch_pin: H36:PC7
pause_on_runout: False
insert_gcode:
    _ON_FILAMENT_INSERT

[filament_switch_sensor bottom_sensor]
switch_pin: H36:PA15
pause_on_runout: True
runout_gcode:
    _ON_FILAMENT_RUNOUT

[gcode_macro _ON_FILAMENT_INSERT]
gcode:
    {% if not printer["filament_switch_sensor bottom_sensor"].filament_detected %}
        M118 Filament detected at top. Loading...
        UPDATE_DELAYED_GCODE ID=_LOAD_LOOP DURATION=0.1
    {% endif %}

[gcode_macro _ON_FILAMENT_RUNOUT]
gcode:
    M118 Filament runout at bottom sensor!
    PAUSE

[delayed_gcode _LOAD_LOOP]
gcode:
    {% if printer["filament_switch_sensor top_sensor"].filament_detected %}
        {% if not printer["filament_switch_sensor bottom_sensor"].filament_detected %}
            # Load small amount using force move to bypass temp checks for the gear path
            FORCE_MOVE STEPPER=extruder DISTANCE=5 VELOCITY=10
            UPDATE_DELAYED_GCODE ID=_LOAD_LOOP DURATION=0.1
        {% else %}
            M118 Bottom sensor triggered.
            _CHECK_AND_PRIME
        {% endif %}
    {% else %}
        M118 Loading stopped: Top sensor clear.
    {% endif %}

[gcode_macro _CHECK_AND_PRIME]
gcode:
    {% set min_temp = printer.configfile.settings.extruder.min_extrude_temp|default(170)|int %}
    {% set current_temp = printer.extruder.temperature %}
    {% if current_temp >= min_temp %}
        M118 Priming nozzle...
        G91
        G1 E50 F600
        G90
        M118 Filament fully loaded.
    {% else %}
        M118 Loaded to gears, but extruder too cold to prime (Temp: {current_temp} < {min_temp}).
    {% endif %}

[gcode_macro UNLOAD_FILAMENT_AUTO]
gcode:
    M118 Starting auto-unload...
    UPDATE_DELAYED_GCODE ID=_UNLOAD_LOOP DURATION=0.1

[delayed_gcode _UNLOAD_LOOP]
gcode:
    {% if printer["filament_switch_sensor top_sensor"].filament_detected %}
        {% set min_temp = printer.configfile.settings.extruder.min_extrude_temp|default(170)|int %}
        {% set current_temp = printer.extruder.temperature %}
        {% if current_temp >= min_temp %}
             G91
             G1 E-5 F1800 # Retract fast
             G90
             UPDATE_DELAYED_GCODE ID=_UNLOAD_LOOP DURATION=0.1
        {% else %}
             M118 Extruder too cold to unload!
        {% endif %}
    {% else %}
        M118 Unload complete.
    {% endif %}
